
                            Siemens EEPROM tool v3.15

        Sorry, there's only russian doc here. :-)
        The programm is rather simple but if anyone wants to write an
        english doc - you are welcome. :-)

        Вот. Это было преуведомление для всяких нерусско-говорящих
товарищей. ;-) Теперь по делу.
        Сия прога предназначена для работы с EEPROM мобильных телефонов
Сименс через Service Mode. Позволяет выгружать/сохранять блоки EEPROM'а как
скопом, так и в индивидуальном порядке. Сохранять на диск опять же все вместе,
либо по отдельности, либо как хотите - в двоичном и текстовом шестнадцатеричном
(hex) формате. Да и вообще - до фига всего. Аналогов с подобной
функциональностью пока не существует. ;-)

Преуведомление для всех:
        Я никоим образом не отвечаю на последствия применения этой программы.
Она поставляется в соответствии с принципом "AS IS" ("как есть")  и вы
используете ее исключительно на свой страх и риск.

Преуведомлени для чайников и ламеров:
        Не используйте эту программу! Особенно, если вы не знаете, что такое
EEPROM и зачем он нужен... Данная программа может быстро и безболезненно
убить ваш телефон и его откачивание - это ваши проблемы. Вероятность того,
что я буду отвечать на письма типа "я сломал свой телефон, помоги мне его
починить" - минимальна.

Преуведомление для крутых программеров:
        Не надо трогать меня с воплями о том, как я криво все написал. Как
мог - так и написал. Что смогу - буду улучшать. Если вы можете лучше -
напишите. Это будет полезнее, чем пустой треп.

        Вот. Это были преуведомления. Теперь перейдем непосредственно к
описанию работы программы. Интерфейс прост, как калькулятор: есть два
списка с блоками ЕЕПРОМа, блоки можно таскать туда и обратно. Правый список
призван непосредственно контактировать с телефоном, левый - с юзером.
Естесственно, само перетаскивание ничего не меняет - информацию в мобилу
пишется только при нажатии на соответствующие кнопочки в правой части.
        Кроме того есть два информационных окна и окно для инициализации
мобилы. Если с последним все понятно и так (выбираем порт, жмем Init и давим
красную трубу на телефоне), то по первым двух скажу чуть подробнее.
В самом левой выдается информация о мобиле, которую удалось получить
соответствующими командами СервисМода. Далеко не все мобилы поддерживают эти
команды. На C/S35 выводится только версия железа и версия прошивки. На
SL45/A3x/A40 - выведется все, кроме IMEI. На S/ME45 и выше выведется вообще
все. Правое окошно информации заполняется после инициализации мобилы и
обновляется после окончания записи в ЕЕПРОМ. Как там написано, оно призвано
показывать информацию о свободном месте... В общем-то, оно так и делает. ;-)
Но если честно, то лично я точно не знаю, действительно ли то, что оно
показывает - это то, что у меня написано. ;-))) Ну то есть, команда для
выводы инфы о месте в СервисМоде есть, а как интерпретировать данные - хрен
его знает. Подня искал - нигде ничего не нашел. В mobEG.dll из комплекта
InitMap'а есть названия параметров соответствующей процедуры из BfB95EG.dll
(кстати, может кто не в курсе? Рекомендую. Много интересного можно узнать.),
но что они обозначают по названиям не понять... Так что, имеющееся сейчас -
это просто моя интуиция основанная на копании ЕЕПРОМов. ;-) Если кто узнает
точнее - намыльте, изменю.
        Так, теперь коснемся кнопочек левой части. Там все интуитивно понятно,
но надо отметить несколько моментов. При сохранении блоков в формате bin и txt
дополнительно к файлу блока создается еще один маленький файлик -
bid и tid, соответственно. В нем записан номер блока и его версия. Можете
кричать, что это криво и неудобно, но мне так нравится: в файле хранится
блок в чистом виде, чтобы его можно было редактировать и ни о чем не думать.
Информационные файлики рекомендуется создавать руками (посмотрите внутрь
и увидите как) перед загрузкой чего-нить самодельного, но грузить bin и
txt в программу можно и без них - если программа не найдет файла с инфой, то
она просто спросить номер блока и его версию. Если выделить несколько блоков,
то при сохранении в bin и txt к имени файла будет добавляться префикс с номером
блока. Что касается сохранения в eep, то тут тоже есть моменты... Теоретически,
файлы совместимы по формату с таковыми от Eeprom_tool by DarkBear. Точнее,
как она будет мои файлы воспринимать - не знаю (тем более, что там, например,
в конец кладется пара байт с типом мобилы...), но если у вас есть старый бэкап
от нее, то моя софтина его всосет без проблем. Если у вас выделен только один
блок, то при сохранении в eep сохранится весь ЕЕПРОМ, а иначе - только
выделенные блоки. Ежели имеется страстное желание сохранить в eep один блок -
оставьте только его, а остальные удалите. ;-)
        Это что касается сохранения. С загрузкой все примерно так же. ;-)
Но есть и свои нюансы. Главный из них - если вы выделяете несколько файлов для
загрузки (будь то eep, bin, txt или map), то они обрабатываются в том порядке,
в котором они написаны в строчке окна загрузки! Следовательно, если будут
встречаться повторяющиеся блоки, то они заменяются на те, которые встретились
позже!!! И на это особенно следует обращать внимание при загрузке маппингов
InitMap'а (фича сия появилась именно во второй версии): когда вы грузите
"общий" стандартный маппинг + дельта-маппинг с утановками операторов.
Кроме того в маппингах есть еще одна фишка: InitMap реально использует не все
блоки, которые записаны в map. Ну просто вообще не все полагается грузить в
телефон... Как бы то ни было, EEPROM tool может грузить и их: если
обнаруживаются таковые блоки, то будет выдан запрос. Нажмете "да" - загрузите
все, нажмете "нет" - только то, что грузит оригинальный InitMap.
        Теперь перейдем, наконец, непосредственно к работе с телефоном, то есть
к правой группе кнопок. Кнопочка "Load all" загружает все, что есть в телефоне.
Сразу скажу, что блоки с IMEI грузиться (да и записываться) не будут - вернее,
на OpenBfB, конечно, будут, а по обычному, на CloseBfB - нет. Однако, если
поставить на телефон патч для OpenBFB, то все будет шоколадно. :-) Кнопочка 
"Save all" сохраняет в телефон все, что есть в правом окне. При этом старое 
содержимое ЕЕПРОМов удаляется!!! (Вернее, удаляется EELITE, но оно не суть 
важно - команды для удаления EEFULL просто нет. Точнее, есть, но она не 
работает. В моделях х65 может удаляться и EEFULL -  подробнее см. примечения 
к версии 3.15) При ClosedBFB и отсутствии бэкапа флеша - почти равносильно
убийству телефона. Так что, пользуемся "Save all" только если на телефон
установлен патч OpenBFB... А вот "Save selected" - сохраняет только
выделенные блоки, не удаляя при этом текущего содержимого. Однако же, в этом 
случае есть небольшие косяки со свободным местом в EEPROM, о чем будет сказано
чуть ниже. Вот-с... Кнопка "Load custom" позволяет самому задать точные номера 
блоков для загрузки - можно задавать несколько штук через запятую или сразу 
диапазон через дефис. Еще есть такая полезная вещь как "Delete directly" - 
удаление блока не только из списка, но и прямо из телефона, не трогая 
остальных.
        Еще хотелось бы остановится на описаниях блоков, которые можно увидеть
в правом столбце каждого списка. Они взяты из комментариев к маппингам InitMap
и привязаны к типу телефона, с которого взяты, поэтому к тому, что появляется
в списке применяется все подряд, первое что подойдет. Иногда оно не есть гуд,
так как, скажем, для SL45 блоки с теми же номерами, что и на других телефонах,
имеют совершенно иное описание и, следовательно, значение. Для таких случаев
предусмотрена специальная "галочка" - "Check hardware ver for description":
выбрав ее, вы оставите только те описания, которые относятся именно к этому
аппарату (если, конечно, программа в курсе, какой сейчас у вас аппарат. ;-) ).
Но, в принципе, использование всей кучи описаний позволяет видеть смысл
наибольшего числа блоков. А это неплохо... Кроме того, в комплект ЕЕПРОМ тула
я вложил специальную маленькую тулзу для самостоятельного создания описаний
блоков из маппингов InitMap - "GetMapDesc". Просто выберите нужные файлы и
она сохранит eeprom.dsc с описаниями и типами мобил. Только помните, что
в последующем будет браться самое ближайшее описание и поэтому желательно
ставить наименее стандартные мобилы в конец списка - чтобы остальным от этого
было лучше.
        Вот, вроде все рассказал в общих чертах... Осталось прояснить буквально
пару моментов:
        - Для работы нужен обычный кабель для Сименсов с внешним питанием.
COM, USB - не суть важно. Лишь бы микросхемы его не от телефона питались.
        - Программа работает под любыми версиями Windows, начиная от Win95.
Для ее работы требуются следующие файлы, которые (если у вас их нет) надо
будет скачать из Сети и положить в системный каталог Windows, если
программа как-нибудь ругается при запуске:
                      msvbvm5.dll
                      MSCOMM32.OCX
                      COMCTL32.OCX
                      comdlg32.ocx
        Вообще, эти файлы входят в установку виндов, начиная с Win98, но
иногда почему-то отсутствуют...
        Под WinNT4 программу лучше не запускать. Комп для работы нужен любой.
Я нормально пускал на обычной четверке (та, что 486).
        - Если программа работает и не выдает никаких ошибок, то это гарантия
того, что в телефон пишется правильная инфа. Service Mode сделан достаточно умно:
там каждая команда и каждый блок данных контролируется CRC. В принципе, сейчас
в программе достаточно "бронебойный" алгоритм, который, теоретически, должен
нормально работать, даже если кабель выдернуть из телефона. ;-)))
        - Вообще, при любых ошибках или глюках мыльте мне с приложением логов
ком-порта, сохраненных LGComSpy (http://latex.hotbox.ru/) - они наиболее
наглядные и удобные для моего быстрого восприятия. Логов от PortMon'а не надо!
	- Появившаяся в третьей версии поддержка телефонов х65 таки их 
поддерживает. ;-) Работает по любому трехпроводочному кабелю (Rx, Tx, Gnd), так
что в случае чего проблемы ищИте не в этом. Тип телефона надо выбирать руками
в соответствующей менюшке - иначе он банально не забутается. ;-) В данный 
момент поддержка х65 находится в состоянии тестирования, так что если ваш 
телефон помрет - в этом нет ничего удивительного и это будут только ваши 
проблемы. ;-) 
	- Версия 3.1 - специально для облегчения жизни тем товарищам, которые
хотят копать с ЕЕПРОМе и пишут софт для работы с какими-то блоками. Во-первых,
сам EEPROM tool теперь принимает в командной строке имя файла с блоком для
моментальной загрузки в левое окно. Во-вторых, в левом окне теперь действует
popup меню, из которого можно запускать внешние проги: текущий выделенный блок
сохраняется во временном каталоге, запускается внешняя программа с его 
путем/именем в качестве параметра, EEPROM tool ждет, пока программа завершится,
потом загружает блок в левое окно (перед этим оно очищается, если очень хочется,
чтобы этого не происходило - намыльте, сделаю...) и прибивает временный файлик.
Чтобы добавить свою программу в выпадающую менюшку авторам, которым это нужно,
достаточно вложить в комплект своих программ reg-файлик примерно следующего 
содержания:
----------------------- линия отрыва ------------------------------
REGEDIT4

[HKEY_CURRENT_USER\Software\VB and VBA Program Settings\Siemens EEPROM tool\ExtApps]

[HKEY_CURRENT_USER\Software\VB and VBA Program Settings\Siemens EEPROM tool\ExtApps]
"ExtAppName"="ExtAppCommandLine"
----------------------- линия отрыва ------------------------------
Собственно, указываем имя программы, каким оно должно быть в выпадающем меню,
и путь к ней...
	- Так как в последнее время с новой силой "восстал" вопрос о буферах в
EEPROM'е, коротенько расскажу для тех, кто не в курсе. Удаляемые из телефона
блоки не удаляются непосредственно, а только помечаются как удаленные, 
продолжая занимать память, которая совсем не безгранична (значение 
"free in buffer"). Если память кончится, то новые блоки записать не получится.
Наиболее это актуально для EELITE - в EEFULL'е худо-бедно, но работает
garbage collection, что проявляется в периодическом увеличении свободного места
в буфере. :-) В EELITE такого нет, а учитывая народную любовь к экспериментам 
с 71 блоком, можно об этом только сожалеть. :-) Если буфер забился под завязку,
выход один - забэкапить все текущие блоки EEPROM'а, удалить его весь, а потом
записать все обратно. Однако, см. выше насчет состояний BFB: все блоки можно
увидеть далеко не всегда. Так что, перед тем, как делать "Load all"-"Save all"
необходимо установить на телефон патч OpenBFB, позаволяющий работать со всеми
блоками...

Вот и все. Будут предложения по поводу дальнейших совершенствований данных фич - 
мыльте.



   Краткая история версий:

                         1.0  - первый релиз
                         1.1  - по многочисленным просьбам... ;-)
                                работает на любых ком-портах (не только на COM1)
                                в начале работы калибрует телефон на скорость
                                115200 и работа идет чуть быстрее...
                                поправлен глюк при сохранении одиночного блока
                         2.0  - до фига всего. Кардинально переделал и
                                увеличил функциональность программы. Лениво
                                все описывать. Сравните хотя бы доку к первой
                                версии и доку ко второй. ;-)
                         2.1  - забыл сделать чтение нескольких маппингов скопом
                                возможность читать маппинги, как это делает
                                InitMap - т.е. пропуская некоторые блоки,
                                которые не должны писАться в телефон
                         2.15 - не мается дурью, если при "Delete directly"
                                ответить "Нет" на запрос.
                         2.2  - добавилась возможность сравнивать блоки
                                левого и правого списков. Не обязательно все -
                                можно только выделенные. Кнопочка "Compare".
	                 2.21 - пофиксил баг - если телефон долго бутался или
				просто не отвечал на первый пинг, то прога 
				бесконечно висела в цикле - сейчас пингует 5 раз
				пофиксил мелкий баг - сразу после инита 
				телефона, если в правом окне ничего нет, нажать
				любой "save...", прога трапалась - теперь просто
				ничего не делает (дизаблить кнопки и отслеживать
				состояние окна мне лениво).
			3.0b  - добавил поддержку х65 в тестовом режиме	
			3.0   - не работало "Delete directly"
				количество доступных ком-портов расширено до 16
				определяет HwId у х65
				галочка PreCheck - вход в СервисМод на 
				включенном телефоне
				добавлены описания блоков для х65 (у которых
				HwId 320 и 323) - рекомендую играться с галочкой
				"Check Hardvare ver...", ибо описания отличаются
				от других моделей
				положение окна, номер ком-порта и всякие галочки
				теперь сохраняются в реестре между сессиями
			3.1   - номера блоков в списках идут с лидирующими нулями
				реагирует на errorcodes, которые возращает телефон
				три операциях с EEPROM'ами - пока воспринимает
				просто как ошибку, т.к. неизвестно, что каждый
				errorcode значит и как на него реагировать, а у
				меня вообще не получилось воспроизвести ситуацию
				их появления...
				принимает имя файла с блокам (eep,bin,txt) в 
				командной строке и сразу открывает его в левом
				окне
				в левом списке по правой кнопке появляется 
				выпадающая менюшка, откуда можно запустить
				внешнюю прогу с передачей ей блока
			3.15  - всякие мелкие фиксы...
				прога читает map'ы от Freia
				появилась менюшка misc.features пока с одним
				пунктом - для развлечений с BFC. Кто не знает,
				что это за фигня - лучше не трогать. ;-))))
				добавил в комплект программы английскую доку
				для версии 2.21 от RussianBear
				изменена логика работы "Save all": теперь
				если в правом списке есть блоки EELITE, то
				удаляется EELITE, если есть блоки EEFULL - 
				удалется EEFULL. Есть есть хоть по одному блоку
				и из того, и из другого - удаляются оба. :-)
				Актуально только для х65, т.к. в предыдущих
				моделях команды для удаления EEFULL вообще нет.


        Ну вот, вроде все сказал. По крайней мере сейчас ничего не вспомню.
;-) Надеюсь сия софтина будет кому-нибудь полезна. Хочу передать свою глубочайшие
респекты SK, который был первым юзером, тестировавшим программу, за что ему
большое спасибо и Viper_rus, который столь же самоотверженно первым тестировал
вторую версию. :-) Кроме того гринигсы идут The Sig (thesig.spils.lv), у
которого я пару раз смотрел описалова к нескольким функциям BfB95eg. :-)
	Кроме того, нельзя не упомянуть уважаемого Single'а, который посильно
участвовал в создании третьей версии (в частности - поделился табличкой CRC16,
а то я бы еще сутки гадал, по какому полиному оно там считается ;-) ). Респект!

	Еще кому хотелось бы передать приветы, благодарности и тому подобное:
		ACiD[mrp]
		chaos
		Sergey[PowerUser]

	Также приветы всем моим друзьям и знакомым и заранее благодарю тех, 
кто разместит эту скромную прогу у себя на сайте. :-))))
	Багрепорты и рациональные предложения присылайте на мыло. 
	А всякие СЦ и прочие личности, которые используют программу в 
коммерческих целях могут присылать свои благодарности в виде WMZ на 
Z309983787306 - буду очень признателен. :-)
	Успехов! :-)))


                                           (c) Copyright Skylord, 2002-2004.
                                                            sky_lord@mail.ru
