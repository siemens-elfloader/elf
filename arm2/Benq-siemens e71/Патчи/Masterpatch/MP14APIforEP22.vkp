; * Master-patch v14 *
;(c) avkiev
;(r) 1nvisible, chaos

;(!) Library, API, SWI

; ready for ELFPack v2.2+

;Run Scanner on startup
;066B328: 0021 BEDF ; E71v41
066B2F8: 0021 BEDF ; E71v45

;Run Scanner instead of REMOTE_SYNCHRONIZATION
;083F9A0: 0xA06E7659 0xA0060C91 ; E71v41
;0840394: 0xA06E8195 0xA0060C91 ; E71v45

;fix langpack "Fern-Sync." => "Refresher"
;1606530: 4665726E2D53796E632E00 526566726573686572FF00 ; E71v41 lg1
;162A805: 4665726E2D53796E632E00 526566726573686572FF00 ; E71v41 lg1
;160653C: 4665726E2D53796E632E00 526566726573686572FF00 ; E71v45 lg1
;162A811: 4665726E2D53796E632E00 526566726573686572FF00 ; E71v45 lg1

+0060000
#pragma enable old_equal_ff
;Bufferizator
C00: DEB5071CC7DFE4800468002C1CD0103C
C10: 10342668002E18D0BE42F9D16668002E
C20: 09D189B03A1C684685A116DF6846211D
C30: 11DF09B0666834788020204004D0B6DF
C40: 01218140214000D10026301CDEBD

;Dispatcher
C50: FEB5061CC7DFE4800568103D10352868
C60: 00280FD0E878B042F8D1A86860B40299
C70: 039A049B059C069D079E089F804760BC
C80: 0028EBE7FEBD

;Scanner
C90: F0B5C7DFE480051C0468002C1CD0103C
CA0: 1034216800290DD0E06800F097F8090E
CB0: 05D0010EA82902D10321884315DF6068
CC0: 15DFEDE7286815DF0020286000210022
CD0: 032304B432DF04BCC7DFDF8000782328
CE0: 49D00124A00214DF061C2E60E00314DF
CF0: 051C60B410214A03474C464FA41AA418
D00: 2068424B9842FAD03F4B9842F7D03C4B
D10: 9842F4D03B4B9842F1D0A3182068B842
D20: 05D100F037F800F04CF80F2084436418
D30: 9C42F3D1394B9C42E1D149A010A10131
D40: C3DF4FA01BA10131C3DF00203060009E
D50: 33A0032109020131012212026B460ADF
D60: 041C311CAA1B6B460CDF201C69460DDF
D70: 301C15DF02B00021F0BD

;Auxiliary
D80: 00B5041C2349043422688A42FBD100F0
D90: 01F817E002B56168316000207060A068
DA0: 00F01CF8B060E06800F021F8F0601034
DB0: 103602BD01B5041C00F003F801BC15DF
DC0: 00BD00B520782870013401350028F9D1
DD0: 013D0A2028706870023500BDFEB500F0
DE0: 06F801B402D0090E00D18047FFBD02B5
DF0: 002803D0010E01D1201A013002BD

;Data
E00: "EELI","EEFU","FFS_","FFS",00 ; Skip 128K
E10: 0x0000BBBB,0xB1C2D3E4,0xA0000000,0xA2000000 ; LGP, Magic, From, To
E20: "0:\\Misc\\Patches\\PTC\\configs.txt",00
E40: "0:\\Misc\\Patches\\PTC\\%08x.ptc",00
E60: "0:\\Misc\\Patches\\Dis\\*.dis",00
E80: "0:\\Misc\\Patches\\Dis\\*.cfg",00
#pragma disable old_equal_ff

CD0: 03 0F ; Ringtone after Refresher
E18: 0xA0000000 0xA0060000 ; From
E1C: 0xA2000000 0xA0080000 ; To
+0

;* Run Refresher on exit from Master-Midlet *
; (c) 1nvisible
; (p) BuG

;0A8E648: 000050E30E00001A6C408FE2 04E08FE204F01FE5090F06A0 ;E71v41
0A8D740: 000050E30E00001A6C408FE2 04E08FE204F01FE5090F06A0 ;E71v45

#pragma enable old_equal_ff
0060F00: 006088E5F081BDE8002801D118A47047
0060F10: EFB52868174B984225D16868164B9842
0060F20: 02D1FFF7B5FE1DE0144B984215D1281C
0060F30: 0830002181DF031C281C203081DF021C
0060F40: 281C183081DF011C02B4281C103081DF
0060F50: 02BCF0B49847F0BC04E0094B984201D1
0060F60: 08A4FFE7EFBDEFBC019807B0FFF7C8EF
0060F70: 000000004D504A43434F4E4652554E46
0060F80: 4D50564E76332E30302052433200
#pragma disable old_equal_ff

;Bufferizator. PatchTable must exists before calling.
;All patches call Bufferizator for getting own options and buffer.
;Input: R0 - PatchId
;If buffer already was allocated - return it in R0 (Z=0).
;If else - tryes allocate buffer by reading according ptc-file (0:\Misc\Patches\%08x.ptc).
;If success - return it in R0 (Z=0), and write it in PatchTable.
;If no - return 0 in R0 (Z=1).
;If patch was disabled globally or in current profile - set Z=1.
;Example of calling Bufferizator from patch:
; LoadReg 0, config+4 ; r0-PatchId
; CallLib Bufferizator
; beq NoPatch

;Refresher. It is part of Scanner. You should assign it to any button (Remote Synchronization).
;It need for hot-refreshing patches options after running MasterMidlet.
;After calling Bufferizator - memory will allocate again, by help reading according ptc-file.

;Scanner. Scans whole flash, searchs configs, merge theirs in file (max=32K), runs theirs startups,
;creates PatchTable (max=1K=64 patches), address of PatchTable writes in RAM.
;If "#" pressed during phone's startup - Scanner won't start. Safe mode...

;Dispatcher
;It is procedure from master-patch, which calls all patches with ID's high byte equal to parameter, which passed via R0.
;It needs for calling several patches from one entrypoint.

;* API *
;(c) avkiev
;Version: 08.03.07

; ready for ELFPack v2.2+

#pragma enable old_equal_ff
;OpenReadCloseFile
006F000: 7EB50D1C802211026B460ADF041C411C
006F010: 17D0002102226B460FDF061C013014DF
006F020: 2860051C00218155201C00226B460FDF
006F030: 201C291C321C6B460BDF201C69460DDF
006F040: 341C201C7EBD

;GetLP
006F060: 30B58C1E258885B0FF21049169460094
006F070: 89DF05B0208825804200A11C89180024
006F080: 0C8030BD

;ProcessFiles
006F090: 03B500F07DF8FA20800014DF011C6031
006F0A0: 03B402991ADF02985C2131DF0099C865
006F0B0: 00985C2131DF2A214170002181700198
006F0C0: 0099021C6BDF002812D00098019900F0
006F0D0: 87F808D0102806D10098C16D17DF0098
006F0E0: 0399FFF7D5FF0198011C6CDF0128ECD0
006F0F0: 0198011C6DDF009815DF02B003BD

; DrawColorPicWithCanvas
; R0 - X
; R1 - Y
; R2 - Pic
; R3 - *color
006F100: 1FB5101C22DF041C029821DF0138013C
006F110: 0099019A0B198018012411B4C7DFF180
006F120: 25DF02B000240FBC10B426DF18BD

; PlayVibra
; R0 - Frequency
; R1 - Duration
; R2 - PlayIfOff (0-no, 1-yes)
006F130: 07B540DF029A104308D000987CDFC7DF
006F140: E4801030019902A201324DDF07BDFFFF
006F150: 00B500207CDF00BD

; CallFunction
006F160: 70B5FF2F0BD8074EBF00F7593E0EFF2E
006F170: 06D0A82E01D0002E01D1381C00E0B847
006F180: 70BDC046004007A0

; Subroutines
006F190: 03B5E4B0E4B0011C6846021C6BDF0028
006F1A0: 17D0694698B0684600F01AF80BD01028
006F1B0: 09D0684601B4694611DF04BC03D4011C
006F1C0: 101CE19A904718B06846011C6CDF0128
006F1D0: E7D06846011C6DDF64B064B003BD
006F1E0: 03B534311ADF009806A117DF0199B531
006F1F0: 08785F2804D0009817DF0199888D0121
006F200: 02B000BD5C000000

;PlaySoundVibra
;R0 - Sound# (if > 0x80, plays with vibra)
;R1 - Vibra Frequency
;R2 - ... Duration
;R3 - Play Vibra If Vibra Off
006F210: 0FB57F23034000200021002204B432DF
006F220: 03BC802907BC00D356DF00BD

;GetWavLen
;In: R0-filename
;Out: R0-duration in ms
006F240: 00B591B0694601AA0A6011DF06D4011C
006F250: 6846021D96DF009815DF079811B000BD

;CreatePath
;In: R0-path
;Out: R0-path (the same)
006F260: 11B599B0011C68461ADF6C4602345C21
006F270: 2170601C18DF00280FD0041C00202070
006F280: 01B401A8694691DF02BC0028EFD101B4
006F290: 01A8694610DF01BCE9E719B011BD

;GetMissedEventCount
;In: R0-event (0=all, 1=missed calls, 2=missed messages, 3=missed other events)
;Out: R0-count
006F2B0: FEB5071C00269DDF00280CD0CA300688
006F2C0: 012F08D0351C4688022F04D0AD198688
006F2D0: 032F00D0AE19301CFEBD0000

; Send_MPlayer_Command
; in: R0 - cmd
; in: R1 - substract
; no=0x0D prev=0x02 next=0x01 fwd=0x12 rwd=0x13 list begin=0x1D track begin=0x27
; pause=0x10 play=0x0E toggle=0x11 stop=0x0F vol_up=0x15 vol_dwn=0x16 kill=0x0C mute=0x0A

006F400: 03B5C7DFE180036803BC5B1A01B40022
006F410: 02490348C7DF000101BDC04653800000
006F420: 09420000

;GetAccessoryType E71v42/EL71v41
;Out: R0 - accesory type
006EF00: D08000EF080090E5000050E31EFF2F01
006EF10: 0400D0E51EFF2FE1
#pragma disable old_equal_ff
