###############################################################################
#                                                                             #
#     IAR Systems ARM Assembler V4.42A/W32 07/Mar/2011  11:51:06              #
#     Copyright 1999-2007 IAR Systems. All rights reserved.                   #
#                                                                             #
#           Source file   =  C:\arm\elfpack_mod_last\main\ALTSWI.asm          #
#           List file     =  C:\arm\elfpack_mod_last\Other\CX75sw25\List\ALTSWI.lst#
#           Object file   =  C:\arm\elfpack_mod_last\Other\CX75sw25\Obj\ALTSWI.r79#
#           Command line  =  C:\arm\elfpack_mod_last\main\ALTSWI.asm          #
#                            -OC:\arm\elfpack_mod_last\Other\CX75sw25\Obj\    #
#                            -s+ -M<> -w+                                     #
#                            -LC:\arm\elfpack_mod_last\Other\CX75sw25\List\   #
#                            -cE -t8 --cpu ARM926EJ-S --fpu None              #
#                            -IC:\arm2\Embedded Workbench 4.0 Evaluation\ARM\INC\ #
#                                                                             #
###############################################################################

    1    00000000              //Альтернативный запуск SWI ф-ии из "запасной"
                                библиотеки
    2    00000000              //(C)Dimadze 2010
    3    00000000              
    4    00000000              /***********************************************
                               ************************************************
                               ***********/
    5    00000000              //int RunSWIFromCashe(void *R0, ...)
    6    00000000              /***********************************************
                               ************************************************
                               ***********/
    7    00000000              //Отыскивает по SWI номеру в кеше, адрес в
                                запасной библиотеке,
    8    00000000              //если всё в порядке, адрес есть, a SWI номер не
                                есть 0x8XXX, то вызывается
    9    00000000              //процедура с соответствующими параметрами. А
                                также перед вызовом данной ф-ии
   10    00000000              //надо занести нужный SWI номер в кеш 
   11    00000000              
   12    00000000              /*
   13    00000000              
   14    00000000              SetSWIHookInRAMState();
   15    00000000              
   16    00000000              SetSWINumInCashe(148); // int ExecuteFile(WSHDR
                                *filepath, WSHDR *mimetype, void *param);
   17    00000000              
   18    00000000              WSHDR *file_path = AllocWS(256);
   19    00000000              wsprintf(file_path, "0:\\execute.elf");
   20    00000000              
   21    00000000              RunSWIFromCashe((void *)file_path, 0, ""); //
                                <--
   22    00000000              
   23    00000000              FreeWS(file_path);
   24    00000000              
   25    00000000              */
   26    00000000              
   27    00000000              //Обязательным условием работы этих ф-ий
                                является
   28    00000000              //RAM SWI HOOK, который устанавливается
                                загрузкой blib 
   29    00000000              //или специальной ф-ей SetSWIHookInRAMState(),
                                хотя бы один раз за запуск телефона
   30    00000000              
   31    00000000              //Допустим ф-ия, которая мы хотим вызвать не
                                имеет параметров,
   32    00000000              //а в этой RunSWIFromCashe есть один обязательны
                               й параметр (R0), тогда что делать?
   33    00000000              //Ответ прост, подставляем ноль и ничего
                                страшного не будет:
   34    00000000              
   35    00000000              /*
   36    00000000              
   37    00000000              SetSWIHookInRAMState();
   38    00000000              SetSWINumInCashe(0x93); // номер SWI RebootPhone
                               ()
   39    00000000              RunSWIFromCashe(0);     // -> Будет перезагрузка
   40    00000000              
   41    00000000              */
   42    00000000              
   43    00000000              /* ------- 0x8XXX ------- */
   44    00000000              
   45    00000000              /*
   46    00000000              
   47    00000000              SetSWIHookInRAMState();
   48    00000000                
   49    00000000              //Поместим номер SWI ф-ии (RamScreenBuffer) в
                                кеш (вплоть до следуещего вызова данной
                                ф-ии)
   50    00000000              SetSWINumInCashe(0x80E0);
   51    00000000              //Т.к. SWI номер через 0x8XXX, то возвращается
                                адрес
   52    00000000              int addr = RunSWIFromCashe(0);
   53    00000000              
   54    00000000              */
   55    00000000              
   56    00000000              //Если ф-ия возвращает:
   57    00000000              //0xBB000000 - то отсутвует запасная RAM
                                библиотека (pLIB_TOP_backup)
   58    00000000              //0xСC000000 - то это реверсивный запуск этой
                                ф-ии
   59    00000000              
   60    00000000                                           CODE32
   61    00000000                                          
   62    00000000                                           EXTERN  pLIB_TOP_ba
 ckup
   63    00000000                                           EXTERN  pLIB_TOP_ca
 she
   64    00000000                                           EXTERN  FUNC_ABORT
   65    00000000              
   66    00000000                                           RSEG    CODE
   67    00000000                                           
   68    00000000                                           //Используемые
                                регистры: R4,R5,R6,R7
   69    00000000                                           
   70    00000000                                           PUBLIC  RunSWIFromC
 ashe_ep
   71    00000000                                         
   72    00000000                        RunSWIFromCashe_ep:
   73    00000000                                           
   74    00000000                                           //Возьмём адрес
                                запасной библиотеки
   75    00000000 60409FE5                                  LDR     R4,
                                                                         =pLIB_
                                                                        TOP_bac
                                                                        kup
   76    00000004 004094E5                                  LDR     R4, [R4,
                                                                         #0x00]
   77    00000008                                           
   78    00000008                                           //Проверка на
                                существование этой библиотеки
   79    00000008 000054E3                                  CMP     R4, 
                                                                          #0x00
   80    0000000C BB04A003                                  MOVEQ   R0, 
                                                                          #0xBB
                                                                         000000
   81    00000010 1EFF2F01                                  BXEQ    LR
   82    00000014                                           
   83    00000014                                           //Возьмём номер SWI
                                ф-ии из кеша
   84    00000014 50509FE5                                  LDR     R5,
                                                                         =pLIB_
                                                                        TOP_cas
                                                                        he
   85    00000018 B050D5E1                                  LDRH    R5, [R5,
                                                                         #0x00]
   86    0000001C                                           
   87    0000001C                                           //Проверка на тип
                                ф-ии 0x8XXX
   88    0000001C FF6EC5E3                                  BIC     R6,  R5,
                                                                          #0x0F
                                                                         F0
   89    00000020 0F60C6E3                                  BIC     R6,  R6,
                                                                          #0x00
                                                                         0F
   90    00000024 800C56E3                                  CMP     R6, 
                                                                          #0x80
                                                                         00
   91    00000028 805CC5E3                                  BIC     R5,  R5,
                                                                          #0x80
                                                                         00
   92    0000002C                                           
   93    0000002C                                           //Вычисление адреса
                                по SWI номеру из кеша
   94    0000002C 0460A0E3                                  MOV     R6, 
                                                                          #0x04
   95    00000030 950607E0                                  MUL     R7,  R5,
                                                                          R6
   96    00000034                                           
   97    00000034 076094E7                                  LDR     R6, [R4,
                                                                         R7]
   98    00000038                                           
   99    00000038                                           //Возвращение
                                адреса запрошенной ф-ии, если ф-ия типа
                                0x8XXX
  100    00000038 0600A001                                  MOVEQ   R0, 
                                                                          R6
  101    0000003C 1EFF2F01                                  BXEQ    LR
  102    00000040                                           
  103    00000040                                           //Проверка на
                                существование запрошенной ф-ии
  104    00000040 010076E3                                  CMP     R6, 
                                                                          #0xFF
                                                                         FFFFFF
  105    00000044 24609F05                                  LDREQ   R6,
                                                                         =FUNC_
                                                                        ABORT
  106    00000048 0500A001                                  MOVEQ   R0, 
                                                                          R5
  107    0000004C 0E10A001                                  MOVEQ   R1, 
                                                                          LR
  108    00000050 16FF2F01                                  BXEQ    R6
  109    00000054                                           
  110    00000054                                           //Проверка на
                                реверсивный запуск этой ф-ии
  111    00000054 18509FE5                                  LDR     R5, 
                                                                          =RunS
                                                                         WIFrom
                                                                         Cashe_
                                                                         ep
  112    00000058 050056E1                                  CMP     R6, 
                                                                          R5
  113    0000005C CC04A003                                  MOVEQ   R0, 
                                                                          #0xCC
                                                                         000000
  114    00000060 1EFF2F01                                  BXEQ    LR
  115    00000064                                           
  116    00000064                                           //Запуск запрошенно
                               й ф-ии
  117    00000064 16FF2FE1                                  BX      R6
  118    00000068                                           
  119    00000068                                           END
  119.1  00000068                       TABLE
  119.2  00000068 ........             Reference on line 75 
  119.3  0000006C ........             Reference on line 84 
  119.4  00000070 ........             Reference on line 105 
  119.5  00000074 ........             Reference on line 111 
  119.6  00000078                      END (including table)
##############################
#          CRC:19BA          #
#        Errors:   0         #
#        Warnings: 0         #
#         Bytes: 120         #
##############################



